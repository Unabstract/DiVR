Bootstrap: docker
From: nvidia/cuda:11.7.1-cudnn8-devel-ubuntu20.04

%post
    apt-get update -y
    apt install -y vim git
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        python3 \
        python3-tk \
        python3-pip \
        python3-dev \
        python3-setuptools \
        libboost-dev
    rm -rf /var/lib/apt/lists/*

    pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu117
    pip3 install numpy matplotlib pandas fvcore iopath einops h5py seaborn smplx[all]
    pip3 install --no-index --no-cache-dir pytorch3d -f https://dl.fbaipublicfiles.com/pytorch3d/packaging/wheels/py38_cu113_pyt1110/download.html
    pip3 install tensorboardx configer

    # install human_body_prior
    cd /home
    git clone https://github.com/nghorbani/human_body_prior.git
    cd human_body_prior
    git checkout origin/cvpr19
    python3 setup.py develop

    # install Pointnet2_PyTorch
    cd /home
    git clone --recursive https://github.com/erikwijmans/Pointnet2_PyTorch.git
    cd Pointnet2_PyTorch
    sed -i '100,101s/^/#/' pointnet2_ops_lib/pointnet2_ops/_ext-src/src/sampling_gpu.cu
    sed -i '196,198s/.*/interpolated_feats = known_feats.repeat(1, 1, unknown.shape[1])/' pointnet2_ops_lib/pointnet2_ops/pointnet2_modules.py
    pip3 install -r requirements.txt
    pip3 install -e .
    cp -r pointnet2 /usr/local/lib/python3.8/dist-packages/

    # fix Torchmetrics
    sed -i '301,308c\
    inv_mask_d0_d1 = ~mask_d0_d1\
    inv_mask_d0_nd1 = ~mask_d0_nd1\
    inv_mask_d2 = ~mask_d2\
    mask_c0 = mask_d2 * mask_d0_d1\
    mask_c1 = mask_d2 * inv_mask_d0_d1\
    mask_c2 = inv_mask_d2 * mask_d0_nd1\
    mask_c3 = inv_mask_d2 * inv_mask_d0_nd1\
    mask_c0 = mask_c0.view(-1, 1).type_as(q0)\
    mask_c1 = mask_c1.view(-1, 1).type_as(q1)\
    mask_c2 = mask_c2.view(-1, 1).type_as(q2)\
    mask_c3 = mask_c3.view(-1, 1).type_as(q3)' \
    /usr/local/lib/python3.8/dist-packages/torchgeometry-0.1.2-py3.8.egg/torchgeometry/core/conversions.py